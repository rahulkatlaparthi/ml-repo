name: Train and Deploy Model (Full Setup)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_WORKSPACE_NAME: ${{ secrets.AZURE_ML_WORKSPACE }}
  LOCATION: eastus

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 0Ô∏è‚É£: Checkout code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Step 1Ô∏è‚É£: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Step 2Ô∏è‚É£: Install dependencies
      - name: Install dependencies
        run: |
          pip install azure-ai-ml azure-identity mlflow

      # Step 3Ô∏è‚É£: Azure Login (using GitHub Secret AZURE_CREDENTIALS)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 4Ô∏è‚É£: Add Azure ML extension
      - name: Add Azure ML extension
        run: |
          az extension add -n ml -y

      # Step 5Ô∏è‚É£: Ensure Resource Group exists
      # - name: Ensure Resource Group exists
      #   run: |
      #     if ! az group show --name $AZURE_RESOURCE_GROUP >/dev/null 2>&1; then
      #       echo "Creating Resource Group..."
      #       az group create --name $AZURE_RESOURCE_GROUP --location $LOCATION
      #     else
      #       echo "Resource Group already exists."
      #     fi

      # Step 6Ô∏è‚É£: Ensure ML Workspace exists
      - name: Ensure ML Workspace exists
        run: |
          if ! az ml workspace show --name $AZURE_WORKSPACE_NAME --resource-group $AZURE_RESOURCE_GROUP >/dev/null 2>&1; then
            echo "Creating Azure ML Workspace..."
            az ml workspace create \
              --name $AZURE_WORKSPACE_NAME \
              --resource-group $AZURE_RESOURCE_GROUP \
              --location $LOCATION
          else
            echo "Workspace already exists."
          fi

      # Step 7Ô∏è‚É£: Ensure Compute Cluster exists
      - name: Ensure Compute Cluster exists
        run: |
          COMPUTE_NAME=cpu-cluster
          if ! az ml compute show --name $COMPUTE_NAME --resource-group $AZURE_RESOURCE_GROUP --workspace-name $AZURE_WORKSPACE_NAME >/dev/null 2>&1; then
            echo "Creating Compute Cluster..."
            az ml compute create \
              --name $COMPUTE_NAME \
              --type amlcompute \
              --size Standard_DS3_v2 \
              --min-instances 0 \
              --max-instances 2 \
              --idle-time-before-scale-down 120 \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME
          else
            echo "Compute cluster already exists."
          fi

      # Step 8Ô∏è‚É£: Submit Training Job
      - name: Submit training pipeline job
        run: |
          az configure --defaults group=${{ env.AZURE_RESOURCE_GROUP }} workspace=${{ env.AZURE_WORKSPACE_NAME }}
          az ml job create --file pipelines/training_pipeline.yml --stream

      # Step 9Ô∏è‚É£: Register Model
      - name: Register model
        run: |
          MODEL_PATH="outputs/model.pkl"
          az ml model create --name sample-model \
                             --type custom_model \
                             --path $MODEL_PATH \
                             --description "Model trained via GitHub Actions"

      # Step üîü: Deploy Model as Endpoint
      - name: Deploy model as endpoint
        run: |
          ENDPOINT_NAME=sample-endpoint
          az ml online-endpoint create --name $ENDPOINT_NAME --file pipelines/endpoint.yml || true
          az ml online-deployment create \
              --name blue \
              --endpoint $ENDPOINT_NAME \
              --model sample-model:1 \
              --instance-type Standard_DS3_v2 \
              --instance-count 1 \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME
